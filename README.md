# Tourist Accommodations Map

An interactive web application that visualizes tourist accommodation data by census section in Spain, using data from the Spanish National Statistics Institute (INE).

## Project Overview

This application provides a visual representation of tourist accommodation distribution across Spain, showing the density of tourism accommodations by census section. Users can filter the data by province, municipality, and accommodation count ranges.

## Directory Structure

- `data/` - Contains input data files and processed output
  - `input/` - Place raw data files here (see README in that directory)
  - `output/` - Contains processed GeoJSON files (generated by scripts)
- `data-processing/` - Data processing scripts and utilities
  - `scripts/` - Python scripts for data processing
- `webapp/` - The web application
  - `src/` - Source code files
  - `dist/` - Compiled application (generated)

## Required Software

- [Node.js](https://nodejs.org/) (for the web application)
- [Python](https://www.python.org/) 3.8 or higher (for data processing)
- [UV](https://github.com/astral-sh/uv) - Fast Python package installer and resolver

## Getting Started

### 1. Clone the Repository

```bash
git clone https://github.com/yourusername/tourist-accommodations-map.git
cd tourist-accommodations-map
```

### 2. Install UV (if not already installed)

```bash
pip install uv
```

### 3. Set Up the Python Environment

```bash
uv venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
uv pip install -r requirements.txt
```

### 4. Download Required Data

Follow the instructions in `data/input/README.md` to download the necessary data files from the Spanish National Statistics Institute (INE).

### 5. Process the Data

```bash
uv run data-processing/scripts/convert_excel_to_csv.py
uv run data-processing/scripts/merge_shapes_with_csv.py
```

### 6. Build and Run the Web Application

```bash
cd webapp
npm install
npm run build
npm run preview
```

The application should now be available at http://localhost:3000/

## Deploying to Cloudflare Pages

There are two primary ways to deploy this application to Cloudflare Pages:

### 1. Using Wrangler CLI (Command Line)

For direct, manual deployments:

1. Install Wrangler if you haven't already:
   ```bash
   npm install -g wrangler
   ```

2. Log in to your Cloudflare account:
   ```bash
   wrangler login
   ```

3. Build the application:
   ```bash
   cd webapp
   npm run build
   ```

4. Remove large GeoJSON files that exceed Cloudflare's 25MB limit:
   ```bash
   rm -f dist/data/output/secciones_with_shapes.geojson
   ```

   Note: Cloudflare Pages has a 25MB file size limit. For production deployments, consider using Cloudflare R2 storage for large data files as described in the "Cloudflare R2 Integration" section below.

5. Create a minimal `wrangler.toml` file in your webapp directory:
   ```toml
   # Cloudflare Pages configuration
   name = "mapping-tourist-accommodations"
   pages_build_output_dir = "dist"
   ```

6. Deploy to Cloudflare Pages:
   ```bash
   npx wrangler pages deploy dist --project-name=mapping-tourist-accommodations
   ```

Your site will be deployed to `mapping-tourist-accommodations.pages.dev` and will also have a unique URL with a hash prefix (e.g., `cbdd917d.mapping-tourist-accommodations.pages.dev`).

### 2. Using GitHub Integration (Recommended for Production)

For continuous deployment:

1. Push your code to a GitHub repository.

2. In the Cloudflare dashboard:
   - Go to Pages > Create a project
   - Select "Connect to Git"
   - Select your repository
   - Set the build command to `cd webapp && npm install && npm run build && rm -f dist/data/output/secciones_with_shapes.geojson`
   - Set the build output directory to `webapp/dist`
   - Add a build environment variable `NODE_VERSION` with value `16` (or your preferred version)

3. Deploy with the "Save and Deploy" button.

4. For a completely automated solution, create a `.github/workflows/cloudflare-pages.yml` file in your repository:
   ```yaml
   name: Deploy to Cloudflare Pages

   on:
     push:
       branches: [main]

   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - uses: actions/setup-node@v2
           with:
             node-version: '16'
         - name: Install dependencies
           run: |
             cd webapp
             npm install
         - name: Build application
           run: |
             cd webapp
             npm run build
         - name: Remove large files
           run: |
             rm -f webapp/dist/data/output/secciones_with_shapes.geojson
         - name: Deploy to Cloudflare Pages
           uses: cloudflare/wrangler-action@v3
           with:
             apiToken: ${{ secrets.CF_API_TOKEN }}
             command: pages deploy webapp/dist --project-name=mapping-tourist-accommodations
   ```

With GitHub integration, any push to the main branch will trigger an automatic deployment to Cloudflare Pages.

## Cloudflare R2 Integration (Optional)

For production deployments, we recommend storing the GeoJSON data in Cloudflare R2 instead of including it in the repository. This allows for:

1. Handling large GeoJSON files that exceed Git's file size limits
2. Better performance when serving large files
3. Separation of code and data concerns

### Setting Up R2 Integration

1. Create a Cloudflare R2 bucket in your Cloudflare dashboard
2. Generate R2 API tokens with appropriate permissions
3. Run the setup script:

```bash
./setup_r2.sh
```

4. Edit the `.env` file with your Cloudflare R2 credentials:

```
R2_ENDPOINT=https://<account_id>.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=<your_access_key_id>
R2_SECRET_ACCESS_KEY=<your_secret_access_key>
R2_BUCKET_NAME=<your_bucket_name>
R2_PUBLIC_URL=<public_url_to_access_files>
```

5. Process and upload the data:

```bash
cd data-processing/scripts
uv run merge_shapes_with_csv.py
```

The script will:
- Generate the GeoJSON file locally
- Upload it to Cloudflare R2
- Create a configuration file with the R2 URL
- The web application will automatically use the R2 URL when available

## Important Note About Running Python Scripts

Always use `uv` to run Python scripts in this project for faster execution and better dependency management:

```bash
uv run path/to/script.py
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Data Sources

- Census sections (Secciones Censales): [INE - Spanish National Statistics Institute](https://www.ine.es/ss/Satellite?L=es_ES&c=Page&cid=1259952026632&p=1259952026632&pagename=ProductosYServicios%2FPYSLayout#)
- Tourist accommodation data: [INE - Experimental Statistics](https://www.ine.es/experimental/viv_turistica/exp_viv_turistica_tablas.htm) 